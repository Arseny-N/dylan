!function(e,t,i,o){e.CodeMirror=i.View.extend({tagName:"div",initialize:function(e){this.options={tabSize:8,indentWithTabs:!0,lineNumbers:!0,lineWarping:!0,theme:["pastel-on-dark","ambiance","cobalt"][1]},o.extend(this.options,e)},render:function(e){var i=e.get(0);return console.log(e),console.log(e[0]),console.log("=============="),this.codemirror=t(i,this.options),this}}),e.ScriptEditor=i.View.extend({model:e.DocumentScript,el:"div#cm-script-editor",initialize:function(t){this.cmView=new e.CodeMirror(t),this.codemirror=this.cmView.render(this.$el).codemirror,this.toolbar=new e.EditorToolbarView({editor:this}),this.tabs=new e.TabListView,this.listenTo(e.docs,"change:file",this.change_doc),this.listenTo(e.dispatcher,"run:file",this.run)},run:function(){return ret=e.interpreter.execute(this.model)},change_doc:function(e){this.model=e,this.codemirror.swapDoc(e.get("CodeMirrorDoc"))}}),e.ReadOnlyTextView=i.View.extend({el:".console #view",history_line:0,history_length:0,initialize:function(t){this.filed="text",o.extend(this,t),this.cmView=new e.CodeMirror({lineNumbers:!1,readOnly:!0}),this.editor=this.cmView.render(this.$el),this.listenTo(this.collection,"add",this.add_one)},add_one:function(e){var t=this.editor.codemirror.getValue();t+=e.get(this.filed)+"\n",this.editor.codemirror.setValue(t)}}),e.EditorToolbarView=i.View.extend({el:"div#editor-toolbar",events:{"click #close-doc":function(){e.dispatcher.trigger("close:file")},"click #copy-to-clbd":"copy_to_clib_board","click #add-doc-empty":"add_doc","click #add-text-doc-empty":"add_text_doc","click #add-doc-disk":"add_doc_disk","click #run-doc":"run_doc","click #download":"download","click #console-toggle":"console_toggle","click #rename-doc":"rename_doc","click #save":function(){e.docs.trigger("save:files")},"click #add-disk-script":function(){e.utils.files.load(e.DocumentScript)},"click #add-disk-text":function(){e.utils.files.load(e.DocumentText)}},initialize:function(e){o.extend(this,{editor:void 0}),o.extend(this,e),this.$sEditor=this.$("#script-editor"),this.$console=this.$(".console"),this.$console_btn=this.$("#console-toggle span.cns-content"),this.$console_icon=this.$("#console-toggle span.glyphicon")},rename_doc:function(){e.dispatcher.trigger("name-change")},copy_to_clib_board:function(){e.utils.copyToClipboard(this.editor.model.get("data"))},add_doc:function(){var t=new e.DocumentScript({name:e.docs.uniqueName()+".js",data:""});e.docs.add(t),e.docs.trigger("change:file",t)},add_text_doc:function(){var t=new e.DocumentText({name:e.docs.uniqueName()+".txt",data:""});e.docs.add(t),e.docs.trigger("change:file",t)},run_doc:function(){e.dispatcher.trigger("run:file")},download:function(){var t=this.editor.model;e.utils.files.save(t)}}),e.TabView=i.View.extend({model:e.Document,template:"",tagName:"li",events:{"click .cross":"close"},initialize:function(){var t=this.model.get("type");this.template=e.utils.mk_templ("script.template.doctab."+t)},render:function(){console.dir(this.model.toJSON()),this.$el.html(this.template(this.model.toJSON())),this.$form=this.$("form"),this.$name=this.$("div.file-name"),this.$btn=this.$("form button"),this.$input=this.$("form input"),console.dir(this);var t=this;return this.$btn.click(function(i){t.model.set("name",t.$input.val()),e.dispatcher.trigger("name-show"),e.dispatcher.trigger("reset-tabs"),i.preventDefault()}),this},close:function(){this.$el.html("")}}),e.TabListView=i.View.extend({view:e.TabView,el:"#editor-tabs",active:void 0,tabs:[],events:{'shown.bs.tab a[data-toggle="tab"]':"change_active_doc"},initialize:function(t){this.options=t||{},this.listenTo(e.docs,"add",this.add_one),this.listenTo(e.docs,"reset",this.add_all),this.listenTo(e.docs,"clear",this.clear),this.listenTo(e.docs,"change:file",this.set_active),this.listenTo(e.dispatcher,"name-change",this.name_change),this.listenTo(e.dispatcher,"name-show",this.name_show),this.listenTo(e.dispatcher,"reset-tabs",this.add_all)},name_change:function(){this.active&&(this.active.$form.removeClass("hidden"),this.active.$name.addClass("hidden"))},name_show:function(){this.active&&(this.active.$form.addClass("hidden"),this.active.$name.removeClass("hidden"))},find_view:function(e){return o.find(this.tabs,function(t){return t.model.get("name")==e})},add_one:function(e){var t=new this.view({model:e});this.tabs.push(t),this.$el.append(t.render().el)},add_all:function(){this.clear(),e.docs.each(this.add_one,this)},clear:function(){this.tabs=[],this.$el.html("")},set_active:function(e){this.name_show(),this.active=this.find_view(e.get("name")),this.active.$el.tab("show")},close_active:function(){this.name_show(),this.active.close();for(var e in this.tabs)this.tabs[e].model.get("name")==this.active.model.get("name")&&(console.dir(this.tabs[e]),delete this.tabs[e])},change_active_doc:function(t){var i=$(t.target).attr("name-attribute"),o=e.docs.findWhere({name:i});e.docs.trigger("change:file",o)}}),e.Dialog=i.Model.extend({defaults:{modal_options:{},title:"",body:""}}),e.DialogView=i.View.extend({model:e.Dialog,initialize:function(){this.template=e.utils.mk_templ("script.template.doctab")},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")}}),e.SrcEditor=i.View.extend({el:"section#editor",initialize:function(t){this.options=t||{},this.activeIndex=0,this.docs=e.docs,this.sh_cut=!1;var i=this;this.listenTo(e.docs,"change:file",function(t){if(!this.sh_cut){var i=e.docs.pluck("name"),n=o.indexOf(i,t.get("name"));this.activeIndex=n}}),this.listenTo(e.dispatcher,"close:file",this.close_doc),this.$cheatsheet=$("#cheatsheet"),Mousetrap.bindGlobal("ctrl+s",function(t){t.preventDefault(),e.docs.trigger("save:files"),console.log("SAVED")}),Mousetrap.bindGlobal("alt+r",function(t){t.preventDefault(),e.dispatcher.trigger("run:file"),console.log("SAVED")}),Mousetrap.bindGlobal("ctrl+alt+pagedown",function(t){t.preventDefault(),i.sh_cut=!0,i.activeIndex++,i.activeIndex>=e.docs.length&&(i.activeIndex=0),doc=e.docs.at(i.activeIndex),e.docs.trigger("change:file",doc)}),Mousetrap.bindGlobal("alt+h",function(e){e.preventDefault(),console.log("HELLO"),console.dir(i.$cheatsheet),i.$cheatsheet.dropdown("toggle")}),Mousetrap.bindGlobal("ctrl+k",function(t){t.preventDefault();var i=new e.DocumentScript({name:e.docs.uniqueName()+".js",data:""});e.docs.add(i),e.docs.trigger("change:file",i)}),Mousetrap.bindGlobal("ctrl+l",function(t){t.preventDefault();var i=new e.DocumentText({name:e.docs.uniqueName()+".txt",data:""});e.docs.add(i),e.docs.trigger("change:file",i)}),Mousetrap.bindGlobal("ctrl+o",function(t){t.preventDefault(),e.utils.files.load(e.DocumentScript)}),Mousetrap.bindGlobal("ctrl+p",function(t){t.preventDefault(),e.utils.files.load(e.DocumentText)}),Mousetrap.bindGlobal("ctrl+alt+pageup",function(t){t.preventDefault(),i.sh_cut=!0,i.activeIndex--,i.activeIndex<0&&(i.activeIndex=e.docs.length-1);var o=e.docs.at(i.activeIndex);e.docs.trigger("change:file",o)});for(var n=function(t){Mousetrap.bindGlobal("alt+"+t.toString(),function(o){if(o.preventDefault(),t-1<e.docs.length){i.sh_cut=!0,i.activeIndex=t-1;var n=e.docs.at(t-1);e.docs.trigger("change:file",n)}})},s=0;10>s;++s)n(s+1);Mousetrap.bindGlobal("alt+w",function(t){t.preventDefault(),i.sh_cut=!0,i.activeIndex=0,e.dispatcher.trigger("close:file")}),this.editor=new e.ScriptEditor;var c=$(document),a=70;$(window).on("resize",function(){var e=$.el_height(c.get(0));i.editor.codemirror.setSize(void 0,e/100*a-150)}).trigger("resize")},close_doc:function(){e.docs.length>1&&(this.editor.tabs.close_active(),e.docs.close_file(this.editor.model))}}),e.AppView=i.View.extend({def_doc_list:[new e.DocumentScript({name:"script.js",data:"/* Hello !*/"})],initialize:function(){e.dispatcher=o.clone(i.Events),e.docs=new e.DocumentCollection([]),e.utils.initialize(),e.interpreter=new e.Interpreter({docs:e.docs,log:e.log,libs:e.libs}),e.editor=new e.SrcEditor({}),e.logs=new e.Logger,e.console=new e.ConsoleView,e.docs.fetch(),e.docs.at(0)||e.docs.add(this.def_doc_list),e.docs.trigger("change:file",e.docs.at(0))}})}(app,CodeMirror,Backbone,_);