!function(e,t){e.LoggerEntry=t.GSModel.extend({defaults:{emitter:"",context:"",body:"",prio:"info"},getters:{line:function(){return this.emitter+this.file+this.prio}},setters:{line:function(e){e=e.split(" "),this.emitter=e[0],this.file=e[1],this.prio=e[2]}},prios:["info","warn","error"]}),e.LoggerRawCollection=t.Collection.extend({model:e.LoggerEntry,initialize:function(e){var t=this;_.extend(this,{max_lenght:50}),_.extend(this,e),this.on("add",function(){if(t.length>t.max_lenght){var e=t.shift();e.get("view").$el.remove()}})}}),e.LoggerScrFilteredCollection=t.Collection.extend({model:e.LoggerEntry,filed:["emitter"],regexp:[void 0],predefined_filter:!1,initialize:function(e,t){_.extend(this,t),this.start_listen(),this.listenTo(this.logs.raw,"add",this.add_one),this.listenTo(this.logs.raw,"reset",this.add_all)},log_filter:function(e,t,i){return this.regexp?!!e.get(t).match(i):!0},add_one:function(e){for(var t in this.filed){var i=this.filed[t],o=this.regexp[t];if(this.log_filter(e,i,o))return void this.add(e)}},add_all:function(){this.reset([],{silent:!0}),e.logs.raw.each(this.add_one,this),this.trigger("reset")},stop_listen:function(){this.predefined_filter||this.stopListening(e.dispatcher,"changed:regexp")},start_listen:function(){var t=this;this.predefined_filter?e.dispatcher.trigger("disable:regexp",!0):(this.listenTo(e.dispatcher,"changed:regexp",function(e){var i=_.indexOf(t.filed,e.filed);console.log("----->"+i),t.regexp[i]=e.regexp,this.add_all()}),e.dispatcher.trigger("disable:regexp",!1))}}),e.LoggerMcFilteredCollection=e.LoggerScrFilteredCollection.extend({model:e.LoggerEntry,filed:["emitter"],regexp:[/^script/],predefined_filter:!0}),e.LoggerConsFilteredCollection=e.LoggerScrFilteredCollection.extend({model:e.LoggerEntry,filed:["emitter","prio","context"],regexp:[/^console/,/^error/,/^console/],predefined_filter:!0,initialize:function(t,i){_.extend(this,i),e.LoggerConsFilteredCollection.__super__.initialize.apply(this),this.console=e.console,this.listenTo(this.console.history,"add",this.add_one),this.listenTo(this.console.history,"reset",this.add_all)}}),e.LoggerScrEntryView=t.View.extend({model:e.LoggerEntry,tagName:"tr",prioToClass:{debug:"",info:"",warn:"warning",error:"danger"},template_selector:"script.template.logger-src-entry",initialize:function(){this.template=e.utils.mk_templ(this.template_selector),this.$el.addClass(this.prioToClass[this.model.get("prio")]),this.model.set("view",this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),e.LoggerMcEntryView=e.LoggerScrEntryView.extend({template_selector:"script.template.logger-mc-entry"}),e.LoggerConsEntryView=e.LoggerScrEntryView.extend({template_selector:"script.template.logger-console-entry"}),e.RegExpInputView=t.View.extend({el:"div#logger-regexp ",text:"",regexp:void 0,events:{"input input":"change_regexp"},initialize:function(){var t=this;this.$input=this.$("input"),this.$input.val(""),this.listenTo(e.dispatcher,"disable:regexp",function(e){t.$input.prop({disabled:e})})},change_regexp:function(t){t.preventDefault(),this.text=this.$input.val(),this.regexp=new RegExp(this.text),""==this.text&&(this.regexp=void 0),e.dispatcher.trigger("changed:regexp",{regexp:this.regexp,filed:"emitter"})}}),e.LoggerToolbarView=t.View.extend({el:"#logger-toolbar",events:{"click #copy-to-clbd":"copy_to_clib_board","click #clear":"clear"},initialize:function(e){this.options=e||{}},copy_to_clib_board:function(){var t=e.logs.filtered.toJSON(),i=_.reduce(t,function(e,t){return e+t.emitter+" "+t.prio+" "+t.body+"\n"},"");console.dir(i),e.utils.copyToClipboard(i)},clear:function(){e.logs.raw.reset()}}),e.LoggerTabs=t.View.extend({el:"#logger-tabs",events:{"click #script-tab":function(){this.logger.set_mode("script")},"click #chip-tab":function(){this.logger.set_mode("mc")},"click #console-tab":function(){this.logger.set_mode("console")}},initialize:function(e){_.extend(this,e)}}),e.Logger=t.View.extend({el:"#logger",modes:{script:{View:e.LoggerScrEntryView,Collection:e.LoggerScrFilteredCollection},mc:{View:e.LoggerMcEntryView,Collection:e.LoggerMcFilteredCollection},console:{View:e.LoggerConsEntryView,Collection:e.LoggerConsFilteredCollection,init:function(){this.$consoleDiv=this.$("div.console")},start:function(){this.$consoleDiv.removeClass("hidden")},stop:function(){this.$consoleDiv.addClass("hidden")}}},initialize:function(t){_.extend(this,t),this.$table=this.$("#logger-container table"),this.regexp_input=new e.RegExpInputView({}),this.tabs=new e.LoggerTabs({logger:this}),this.toolbar=new e.LoggerToolbarView({}),this.raw=new e.LoggerRawCollection;var i=$("#logger-container");this.raw.on("add",function(){i.get(0).scrollTop=i.get(0).scrollHeight}),this.set_mode("mc"),this.set_mode("script")},start_listen:function(e){e&&(this.listenTo(e,"add",this.add_one),this.listenTo(e,"reset",this.add_all),this.listenTo(e,"clear",this.clear),e.start_listen&&e.start_listen())},stop_listen:function(e){e&&(this.stopListening(e),e.stop_listen&&e.stop_listen())},set_mode:function(e){var t=this.modes[e];t&&(this.stop&&this.stop.apply(this),this.stop_listen(this.filtered),t.cache&&t.cache.collection||(t.cache||(t.cache={}),t.cache.collection||(t.cache.collection=new t.Collection([],{logs:this}))),this.filtered=t.cache.collection,this.start_listen(this.filtered),t.init&&(t.init.apply(this),t.init=void 0),t.start&&t.start.apply(this),this.stop=t.stop,this.View=t.View,this.add_all())},add_one:function(e){var t=new this.View({model:e});this.$table.append(t.render().el)},add_all:function(){this.clear(),this.filtered.each(this.add_one,this)},clear:function(){this.$table.html("")}}),e.log=function(t,i,o,n){var s;n=n||"info",s="object"==typeof t?t:{emitter:t,body:o,prio:n,context:i},e.logs.raw.add(new e.LoggerEntry(s))}}(app,Backbone);