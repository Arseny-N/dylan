var app=app||{};!function(e,t,r){t.GSModel=t.Model.extend({get:function(e){return _.isFunction(this.getters[e])?this.getters[e].call(this):t.Model.prototype.get.call(this,e)},set:function(e,r,o){var n,i;_.isObject(e)||null==e?(n=e,o=r):(n={},n[e]=r),o=o||{};for(i in n)_.isFunction(this.setters[i])&&(n[i]=this.setters[i].call(this,n[i],o));return t.Model.prototype.set.call(this,n,o)},getters:{},setters:{}}),e.Document=t.GSModel.extend({defaults:{type:"none",readOnly:!1,name:"",data:""},disk_read_setup:function(e){var t=this;return this.reader=new FileReader,this.reader.onload=function(r){return r.target.readyState==FileReader.DONE&&t.set("data",r.target.result),e(r)},this.reader}}),e.DocumentText=e.Document.extend({defaults:{type:"text",encoding:""},mode:{name:"text"},disk_read:function(e,t){return this.disk_read_setup(t).readAsText(e,this.get("encoding"))},getters:{data:function(){return this.CodeMirrorDoc?this.CodeMirrorDoc.getValue():""},CodeMirrorDoc:function(){return this.CodeMirrorDoc||(this.CodeMirrorDoc=new r.Doc("",this.mode)),this.CodeMirrorDoc}},setters:{data:function(e){return this.CodeMirrorDoc||(this.CodeMirrorDoc=new r.Doc("",this.mode)),this.CodeMirrorDoc.setValue(e)}}}),e.DocumentScript=e.DocumentText.extend({defaults:{type:"script",encoding:""},mode:{name:"javascript",json:!0}}),e.DocumentBin=e.Document.extend({defaults:{type:"binary",readOnly:!0},disk_read:function(e,t){return this.disk_read_setup(t).readAsBinaryString(e)}}),e.DocumentCollection=t.Collection.extend({model:e.Document,url:"/api/documents",localStorage:new t.LocalStorage("dylan-documents2",{serialize:function(e){var t={name:e.get("name"),data:e.get("data"),type:e.get("type")};return t[e.idAttribute]=e.get(e.idAttribute),console.dir(t),JSON.stringify(t)},deserialize:function(t){console.log("-------->"+t);var r=JSON.parse(t);if(!r)return void 0;var o="text"==r.type?e.DocumentText:"script"==r.type?e.DocumentScript:void 0;if(!o)return void 0;var n=new o(r,{collection:e.docs});return console.dir(n),n}}),initialize:function(){var e=this;this.on("close:file",this.close_file),this.on("save:files",function(){e.each(function(e){e.get("sc-id")||e.set("sc-id",Math.round(1e11*Math.random(16)).toString(16)),e.save()})})},uniqueName:function(){return"random-"+Math.round(1e11*Math.random(16)).toString(16)},close_file:function(e){console.log("----------------------------"),console.dir(e),e.destroy(),this.trigger("change:file",this.at(0))}})}(app,Backbone,CodeMirror);