!function(e,i){e.ConsoleLine=i.GSModel.extend({defaults:{body:"",emitter:"console"},prefix:"> ",setters:{body:function(e){return console.log(this.prefix+e),this.prefix+e}},raw_body:function(){return this.get("body").slice(this.prefix.length)}}),e.ConsoleLineCollection=i.Collection.extend({model:e.ConsoleLine}),e.ConsoleLineView=i.View.extend({el:".console #input div",history_line:0,history_length:0,initialize:function(i){var t=this;_.extend(this,i),this.cmView=new e.CodeMirror({lineNumbers:!1}),this.editor=this.cmView.render(this.$el),this.editor.codemirror.on("inputRead",function(){t.input_read.call(t)}),this.editor.codemirror.on("keyHandled",function(e,i,o){t.key_handled.call(t,e,i,o)}),this.context={},e.interpreter.ctx_setup(this.context,"console",["api","logger",{as:"r",lib:"console_api.r"},{as:"m",lib:"console_api.m"},{lib:"logger.info",as:"info"},{lib:"logger.error",as:"error"}]),this.context.eval_str.start+=" return ",console.dir(this.context)},input_read:function(){this.history_line=-1},key_handled:function(i,t){var o,r;switch(t){case"Up":this.history_line<this.history.length&&(this.history_line++,o=this.history.at(this.history.length-this.history_line-1),r=o.raw_body(),this.editor.codemirror.setValue(r));break;case"Down":if(this.history_line>0){this.history_line--,o=this.history.at(this.history.length-this.history_line-1),r=o.raw_body(),this.editor.codemirror.setValue(r);break}this.history_line=-1,this.editor.codemirror.setValue("");break;case"Enter":o=this.editor.codemirror.getValue(),this.editor.codemirror.setValue(""),o=o.replace(/\n/g,""),o=o.replace(/ /g,""),o=o.replace(/\t/g,""),""!=o&&(console.dir(this.context),e.interpreter.execute(o,this.context),this.history.add(new e.ConsoleLine({body:o})));default:this.history_line=-1}}}),e.ConsoleView=i.View.extend({initialize:function(){this.history=new e.ConsoleLineCollection,this.input=new e.ConsoleLineView({history:this.history})}})}(app,Backbone);